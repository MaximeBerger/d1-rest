<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enregistrer un score par thème</title>
  <style>
    :root { --bg:#0b1020; --card:#121934; --ink:#e8ecff; --sub:#9aa5d1; --accent:#7aa2ff; --good:#1fbf75; --bad:#f25757; }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:radial-gradient(1200px 800px at 10% -10%, #1b2558 0, rgba(27,37,88,0) 60%),
      radial-gradient(1000px 700px at 100% 0, #163a63 0, rgba(22,58,99,0) 60%), var(--bg); color:var(--ink);}
    .container{max-width:720px; margin:40px auto; padding:0 16px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08);
      border-radius:16px; padding:20px 20px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);}
    h1{font-size:1.4rem; margin:0 0 4px;}
    p.sub{color:var(--sub); margin:0 0 18px;}
    form{display:grid; gap:14px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    label{font-size:.9rem; color:var(--sub); margin-bottom:6px; display:block;}
    input, select{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.03); color:var(--ink); outline:none;}
    input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(122,162,255,.2)}
    .actions{display:flex; gap:10px; align-items:center;}
    button{padding:12px 16px; border:none; border-radius:12px; color:white; background:var(--accent); font-weight:600; cursor:pointer;}
    button[disabled]{opacity:.6; cursor:not-allowed}
    .muted{color:var(--sub); font-size:.9rem}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; font-size:.85rem; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08)}
    .ok{color:var(--good)} .err{color:var(--bad)}
    .toast{position:fixed; right:16px; bottom:16px; background:#11183a; border:1px solid rgba(255,255,255,0.12); color:var(--ink); padding:12px 14px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.35); opacity:0; transform: translateY(10px); transition:.2s;}
    .toast.show{opacity:1; transform: translateY(0)}
    code.inline{background:rgba(255,255,255,0.08); padding:2px 6px; border-radius:6px}
    .help{margin-top:10px; font-size:.9rem}
    .footer{margin-top:16px; display:flex; justify-content:space-between; align-items:center;}
    .api{font-size:.85rem; color:var(--sub)}
    .api a{color:var(--ink)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Enregistrer un score par thème</h1>
      <p class="sub">Template minimal pour POSTer vers votre Worker Cloudflare (API REST D1).</p>

      <form id="scoreForm">
        <div>
          <label for="external_id">Identifiant étudiant <span class="muted">(ex. <code class="inline">etu_001</code>)</span></label>
          <input id="external_id" name="external_id" required autocomplete="username" />
        </div>
        <div class="row">
          <div>
            <label for="theme_code">Code thème <span class="muted">(ex. <code class="inline">PROBA</code>)</span></label>
            <input id="theme_code" name="theme_code" required />
          </div>
          <div>
            <label for="max_score">Barème (max)</label>
            <input id="max_score" name="max_score" type="number" min="0.01" step="0.01" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="score">Score obtenu</label>
            <input id="score" name="score" type="number" min="0" step="0.01" required />
          </div>
        </div>
        <div class="actions">
          <button id="submitBtn" type="submit">Enregistrer</button>
          <span id="pctBadge" class="badge">% calculé : <strong id="pctVal">—</strong></span>
        </div>
        <div class="help muted">
          <div>Endpoint attendu (modifiable dans <code class="inline">API_ENDPOINT</code>) : <code class="inline">POST /api/scores</code></div>
          <div>Payload JSON : <code class="inline">{ external_id, theme_code, score, max_score }</code></div>
        </div>
      </form>

      <div class="footer">
        <div class="api">Astuce : la dernière cible API est mémorisée dans le stockage local.</div>
        <div>
          <label for="api_endpoint" class="muted">API</label>
          <input id="api_endpoint" style="width:320px" placeholder="/api/scores" />
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // === Réglages ===
    const endpointInput = document.getElementById('api_endpoint');
    const savedEndpoint = localStorage.getItem('api_endpoint') || '/api/scores';
    endpointInput.value = savedEndpoint;

    function setToast(msg, ok = true){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.toggle('show', true); t.style.borderColor = ok ? 'rgba(31,191,117,.6)' : 'rgba(242,87,87,.6)';
      setTimeout(()=> t.classList.remove('show'), 2600);
    }

    // % calculé
    const scoreEl = document.getElementById('score');
    const maxEl   = document.getElementById('max_score');
    const pctEl   = document.getElementById('pctVal');

    function refreshPct(){
      const s = parseFloat(scoreEl.value);
      const m = parseFloat(maxEl.value);
      if(!isFinite(s) || !isFinite(m) || m <= 0){ pctEl.textContent = '—'; return; }
      const p = Math.max(0, Math.min(100, (s/m)*100));
      pctEl.textContent = p.toFixed(2) + '%';
    }
    scoreEl.addEventListener('input', refreshPct);
    maxEl.addEventListener('input', refreshPct);

    // Soumission
    document.getElementById('scoreForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const external_id = document.getElementById('external_id').value.trim();
      const session     = "Positionnement";
      const theme_code  = document.getElementById('theme_code').value.trim();
      const score       = parseFloat(document.getElementById('score').value);
      const max_score   = parseFloat(document.getElementById('max_score').value);

      if(!external_id || !theme_code || !isFinite(score) || !isFinite(max_score) || max_score <= 0){
        setToast('Champs invalides', false); return;
      }

      const API_ENDPOINT = endpointInput.value.trim() || '/api/scores';
      localStorage.setItem('api_endpoint', API_ENDPOINT);

      const payload = { external_id, session, theme_code, score, max_score };

      try{
        btn.disabled = true; btn.textContent = 'Enregistrement…';
        const res = await fetch(API_ENDPOINT, {
          Authorization: 'Bearer',
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));

        if(!res.ok){
          const msg = data?.error || res.status + ' ' + res.statusText;
          setToast('Erreur: ' + msg, false);
        } else {
          const pct = (score/max_score*100).toFixed(2);
          setToast(`OK — ${external_id} · ${theme_code} = ${score}/${max_score} (${pct}%)`);
          e.target.reset(); refreshPct();
        }
      } catch (err){
        setToast('Erreur réseau: ' + err.message, false);
      } finally {
        btn.disabled = false; btn.textContent = 'Enregistrer';
      }
    });
  </script>

  <!--
  ===============================
  Exemple d’API (Worker Cloudflare)
  ===============================


  -->
</body>
</html>
